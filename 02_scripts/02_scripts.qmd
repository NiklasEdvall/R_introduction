---
title: "Script och importera data"
author: "Niklas Edvall"
format: PrettyPDF-pdf
    
editor: visual
#install extension prettypdf with: quarto install extension nrennie/PrettyPDF
#https://nrennie.rbind.io/blog/making-pretty-pdf-quarto/
editor_options: 
  chunk_output_type: console
---

## Script

För att slippa skriva saker för hand hela tiden är steg ett när man jobbar med R att skriva ett script för sin analys. I Rstudio finns ikonen för att skapa nya filer uppe till vänster och där väljer man *R script* för att skapa ett nytt sådant.

![New File - R Script](screenshots/new_script.png)

I sitt script kan man nu skriva hela sin analys-pipeline från början till slut. Vill vi t.ex undersöka om det finns en statistisk signifikant skillnad mellan män och kvinnor att välja chokladglass före vanilj när de får frågan: *Skulle du hellre äta choklad- än vaniljglass?* Kan vi skriva följande analys-script.

Vi kodar kön som `M` eller `F` i variabeln `sex`, och om man svarade ja som `Y` eller nej som `N` i variabeln `ic.choco`

```{r}
#Create variable for sex
sex <- c("M", "F", "M", "M", "F", "M", "F", "F", "M", "F", "F")

#Create variable for ice cream preference
ic.choco <- c("Y", "Y", "Y", "Y", "N", "N", "N", "N", "Y", "N", "N")

#Fishers exact test
fisher.test(sex, ic.choco)
```

Vi ser att testet resulterar i ett p-värde = 0.08, vilket betyder att vi inte kan påvisa statistiskt signifikant skillnad mellan grupperna på den klassiska 5%-nivån för statistisk signifikans.

## Importera data och *packages*

Självklart är det galenskap att skriva in sin data manuellt med hjälp av funktionen `c()`

Istället vill vi importera data från en separat datafil som vi sparat. Det finns flera olika sätt att göra detta på, här använder vi ett paket som heter `readr` för att importera vår data som finns sparad i en csv-fil.

#### Paket?

R har en massor av inbyggda funktioner men det finns oändligt många fler skräddarsydda funktioner att installera om man vill ha särskild funktionalitet. Dessa kommer i form av olika *packages* eller paket, och man kan ladda de man specifikt behöver för sitt aktuella script.

Första gången man vill använda ett paket måste man installera det med funktionen `install.packages()`, för att installera paketet `readr` anger vi `install.packages("readr")`.

När man vill använda ett paket i sitt script laddar man det med `library()`. Så, för att ladda vår data-fil med `readr` till en data frame vi kallar `dat` börjar vårat script med:

```{r}
#| include: false
library(readr)

dat <- read_csv("data.csv")
```

Fördelen med `readr` är att man också kan gå till *import dataset* och välja att importera data från en text-fil med `readr`. Då kan man även välja att t.ex exkludera vissa variabler eller ange olika format för variabler. Dialogrutan för att importera data skapar även en kod-snutt man klistra in i sitt script för att spara exakt parametrarna man använt för att importera data.

![Import dataset](screenshots/import_dataset.png){width="391"}

## Vår exempel-data

Vår exempel-data innehåller ett unikt ID-nummer per deltagare, info om kön, ålder och självrapporterad hörselstatus. Hörtrösklar vid fyra frekvenser (0.5, 1, 2 och 4 kHz) per öra och de 25 frågor som återfinns på frågeformuläret Tinnitus Handicap Inventory (THI). Vi kommer använda datan för att se om vi kan besvara:

1.  Överensstämmer självrapporterad hörsel med tonmedelvärde?

2.  Är det skillnad mellan hur män och kvinnor besvarar THI?

3.  Förändras hörseln med åldern?

## Inspektera data

För att få en första överblick kan vi inspektera vår data. Enklast är att klicka på variabeln *dat* för vår data frame i det övre fönstret till höger i Rstudio.

![Vår data frame "dat"](screenshots/view_data.png)

Nedan ser vi med funktionen `dim()` att vår data har dimension 200x34, dvs 200 observationer (rader) för 37 olika variabler (kolumner). Funktionen `names()` returnerar namnen för alla kolumner i vår data. I funktionen `head()` specificerar vi att få tillbaka de första 3 raderna och 8 kolumnerna.

```{r}
#Dimensions of dat frame
dim(dat)

#Column names in dat frame
names(dat)

#Look at first 3 rows and 8 columns of dat
head(dat, c(3,8))
```

Notera att vi även ser vilken **typ** av variabel vi har i returen för `head()`, under kolumnens namn anges `<dbl>`, en förkortning för *double precision floating point* vilket betyder numerisk data. Vi behöver städa lite i vår data för att specificera vad som är numerisk data och vad som är kategorisk data.

## Städa data

### Kategoriska variabler

Kategoriska variabler i R kallas för faktor-variabler. Vi specificerar en faktor-variabel med funktionen `factor()`. Vill vi ange att variabeln *item.1* i vår data är en faktor är det dock ingen idé att bara ange:

```{r}
#Make factor of item.1
factor(dat$item.1)
```

Visserligen returneras *item.1* som en faktor, men vi måste spara den outputen till vår data frame genom att ange:

```{r}
#Make factor and write to data frame
dat$item.1 <- factor(dat$item.1)
```

Vi råkar veta att *item.1* kodar för kön och kan göra detta tydligt genom att specificera ytterligare parametrar i funktionen `factor()` enligt nedan. Parametrarna `levels` (vilka kategorier variabeln innehåller) och `labels` (vad vi vill namnge dessa) åtskiljs med kommatecken.

Kom ihåg att `? factor` alltid visar hjälpavsnittet för funktionen och ger exempel på hur den kan användas.

```{r}
#Make factor, specify levels & labels, and write to data frame
dat$item.1 <- factor(dat$item.1, 
                      levels = c(1,2), 
                      labels = c("M", "F"))
```

### Ändra namn på variabler i en data frame

Det vore även smidigt att ge kolumnen ett mer beskrivande namn. Minns tillbaka hur funktionen `names()` gav oss alla kolumn-namn ovan, vi kollar igen:

```{r}
#Column names in data frame
names(dat)
```

Vi kan använda `names()` för döpa om variabler i en data frame. Vi ser att *item.1* är den andra variabeln i *data*, dvs har index 2. Men, det är strikt förbjudet att använda detta för att t.ex skriva: `names(dat)[2] <- "sex"`

Om kolumnen skulle få ett annat index, vilket ofta händer, kommer det sluta med att vi döper om någon annan kolumn och har förstört vår data totalt.

Istället hänvisar vi till ett dynamiskt index, `names(dat) == "item.1"`, som döper om alla kolumner med namnet *item.1* till *sex*

```{r}
#Rename variable for sex
names(dat)[names(dat) == "item.1"] <- "sex"
```

På samma sätt definerar vi sen vairabeln *item.3* som faktor-variabel och ändrar namn på den och variabel *item.2*

```{r}
#| include: false
#Make factor of "do you have a hearing problem?"
dat$item.3 <- factor(dat$item.3, 
                      levels = c(1,2,3,4), 
                      labels = c("No", "Sometimes", 
                                 "Often", "Always"))

names(dat)[names(dat) == "item.2"] <- "age"
names(dat)[names(dat) == "item.3"] <- "hearing"
```

### Skapa nya variabler

Vårat dataset innehåller hörtrösklar vid fyra frekvenser (0.5, 1, 2 och 4 kHz) per öra som vi kan använda för att räkna ut tonmedelvärde (*Pure Tone Average*; PTA4). Det är lätt att skapa/ange en ny variabel i vår data frame med `$` från medelvärdet av de fyra andra variablerna. Radbyte spelar ingen roll i scriptet, så länge alla symboler är på plats. Här skrivs varje referens till en variabel på egen rad för att det ska vara lättläsligt.

```{r}
#Create variable for PTA4 Right
dat$PTA4.R <- (dat$R500 +  
               dat$R1000 + 
               dat$R2000 + 
               dat$R4000) / 4

#Create variable for PTA4 Left
dat$PTA4.L <- (dat$L500 +  
               dat$L1000 + 
               dat$L2000 + 
               dat$L4000) / 4
```

Vi har 25 variabler som heter THI_1, THI_2, THI_3.. osv. till THI_25. Dessa representerar svar på ett frågeformulär om tinnitus kallat *Tinnitus Handicap Inventory*. Svaren är redan kodade som antingen 0, 2 eller 4 vilket motsvarar de poäng man får för svarsalternativen. Maxpoäng är alltså 25 \* 4 = 100, och ju högre poäng desto mer besvärad är man av tinnitus.

Det vore intressant att skapa en ny variabel med varje försökspersons totala poäng på THI. Vi namnger denna variabel som *THIscore*. Det finns flera sätt att göra detta på. Enklast vore att helt enkelt summera de 25 variablerna:

```{r}
#| eval: false

#Sum all THI-variables to new variable THIscore
dat$THIscore <- dat$THI_1 + dat$THI_2 + dat$THI_3 ...
```

Det är funktionsdugligt, men det blir mycket att skriva och blir både svårläst, oflexibelt och ostabilt om t.ex en variabel får ett nytt namn eller kodas på något annat sätt. Det finns alltid flera sätt att åstadkomma samma sak på med R, och vissa är smidigare än andra.

I det här fallet kan vi skapa en ny variabel som vi kallar *THI.names* med hjälp av funktionen `paste()` som klistrar ihop (eller 'konkatenerar') olika saker med en avskiljare (eller 'separator') som vi specificerar. Här konkatenerar vi bokstäverna "THI" med talen 1 till 25 avskiljda med ett understreck "\_"

På så sätt innehåller då vår nya variabel *THI_names* namnen på alla de kolumner vi är intresserade av att summera.

```{r}
#Create variable of column names relevant to THI
THI.names <- paste("THI", 1:25, sep="_")
```

Vi kan sen använda funktionen `apply()` för att applicera funktionen `sum()` på alla rader (rader specificerar vi med `MARGIN = 1`) i vår data frame som har ett namn som finns i variablen *THI.names* och skriva resultatet till en ny variabel som vi igen kallar *THI.score*

```{r}
#Calculate total THI score per subject
dat$THIscore <- apply(dat[,THI.names], MARGIN = 1, FUN = sum)
```

## Analys

Vi kan nu besvara våra frågeställningar från början av dokumentet.

### 1. Överensstämmer självrapporterad hörsel med tonmedelvärde?

Vi börjar med att göra en enkel plot. När vi ger funktionen en faktor-variabel och en numerisk variabel skapas automatiskt en boxplot. Vi passar på att specificera en titel för ploten, och en rubrik för X- respektive Y-axel.

```{r}
plot(dat$hearing, dat$PTA4.L,
     main = "Self-reported hearing vs PTA, Left ear",
     xlab = "Do you experience difficulties hearing?",
     ylab = "PTA4 (dB HL)")

plot(dat$hearing, dat$PTA4.R,
     main = "Self-reported hearing vs PTA, Right ear",
     xlab = "Do you experience difficulties hearing?",
     ylab = "PTA4 (dB HL)")
```

Vi börjar enkelt, men är du estetiskt lagd finns det massor av verktyg för att göra vackra figurer med R, se till exempel [galleriet för paketet ggplot2](https://r-graph-gallery.com/ggplot2-package.html).

För statistisk analys av om det är skillnad mellan de fyra grupperna gör vi en ANOVA med funktionen `aov()` för vänster respektive höger öras tonmedelvärde, spar resultatet från beräkningen i en ny variabel för vänster och höger öra separat och tittar på en sammanfattning av resultatet med `summary()`

```{r}
#Calculate anova for PTA ~ hearing
anova.L <- aov(data = dat, PTA4.L ~ hearing)
anova.R <- aov(data = dat, PTA4.R ~ hearing)

#Show ANOVA result summary
summary(anova.L)
summary(anova.R)
```

I båda fallen verkar det finnas ett starkt samband mellan tonmedelvärde och självrapporterade hörselsvårigheter (p \< 0.001).

Vi gör ett *pairwise t-test* som post-hoc analys som också korrigerar p-värdet för flera jämförelser och returnerar en tabell över p-värdet som resulterar när alla fyra grupper jämförs sinsemellan.

```{r}
#Pairwise t-test Left ear PTA and self-reported hearing
pairwise.t.test(dat$PTA4.L, dat$hearing, 
                p.adjust.method = "bonferroni")

#Pairwise t-test Right ear PTA and self-reported hearing
pairwise.t.test(dat$PTA4.R, dat$hearing, 
                p.adjust.method = "bonferroni")
```

### 2. Är det skillnad mellan hur män och kvinnor besvarar THI?

För att besvara denna fråga gör vi ett enkel chi-square-test och en box-plot på samma sätt som innan.

```{r}
#Chi square test of THI score for sex
chisq.test(dat$sex, dat$THIscore)

#Box plot of THI score for sex
plot(dat$sex, dat$THIscore,
     main = "THI score for Male (M) and Female (F)",
     xlab = "Sex",
     ylab = "THI total score")
```

Vår plot verkar indikera att män fått lite högre poäng på THI men vårat test resultat 35.9, p = 0.117 påvisar ingen statistiskt signifikant skillnad mellan grupperna.

### 3. Förändras hörseln med åldern?

```{r}
#Set plot space to two columns
par(mfrow=c(1,2))

#Scatter plot of PTA LEFT as function of age
plot(dat$age, dat$PTA4.L,
     pch = 20,
     main = "PTA Left ear vs age",
     xlab = "Age (years)",
     ylab = "PTA Left (dB HL)")

#Best fit linear regression LEFT
abline(lm(data = dat, PTA4.L ~ age), lwd = 2, col = "red")

#Scatter plot of PTA RIGHT as function of age
plot(dat$age, dat$PTA4.R,
     pch = 20,
     main = "PTA Right ear vs age",
     xlab = "Age (years)",
     ylab = "PTA Right (dB HL)")

#Best fit linear regression RIGHT
abline(lm(data = dat, PTA4.R ~ age), lwd = 2, col = "red")

#Save linear regression model to variable
linear.reg.L <- lm(data = dat, PTA4.L ~ age)
linear.reg.R <- lm(data = dat, PTA4.R ~ age)

#Print summary of linear regression model
summary(linear.reg.L)
summary(linear.reg.R)
```
